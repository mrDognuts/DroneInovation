<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Damage Detection</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <h2>Upload Images for Analysis</h2>
        <div id="drag-drop-area" class="drag-drop-area">
            <p>Drag and drop images here, or click to select images.</p>
            <input type="file" id="input-images" accept="image/*" multiple style="display: none;" />
        </div>

        <button onclick="predict()">Analyze Images</button>
        <button type="button" onclick="resetPage()">Reset</button>

        <div id="loading-indicator" class="loading-indicator">Loading...</div>

        <div id="image-preview-container" class="image-preview-container"></div> <!-- Image preview area -->
        <div id="prediction-results" class="prediction-results"></div> <!-- Prediction result area -->
    </div>

    <script>
        // Handling drag-and-drop functionality
        const dragDropArea = document.getElementById('drag-drop-area');
        const inputImages = document.getElementById('input-images');
        const predictionResults = document.getElementById('prediction-results');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        let filesToUpload = []; // To store files before sending to the server

        // Trigger file selection when the area is clicked
        dragDropArea.addEventListener('click', () => {
            inputImages.click();
        });

        // Handle drag-over event
        dragDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dragDropArea.classList.add('hover');
        });

        // Handle drag-leave event
        dragDropArea.addEventListener('dragleave', () => {
            dragDropArea.classList.remove('hover');
        });

        // Handle drop event
        dragDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dragDropArea.classList.remove('hover');
            const files = e.dataTransfer.files;
            handleFiles(files);
        });

        // Handle file selection
        inputImages.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // Handle file upload and preview
        function handleFiles(files) {
            imagePreviewContainer.innerHTML = ''; // Clear previous previews
            filesToUpload = Array.from(files); // Store files for later submission

            // Preview images
            filesToUpload.forEach(file => {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.alt = 'Image Preview';
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                const card = document.createElement('div');
                card.classList.add('image-card');
                card.appendChild(img);
                imagePreviewContainer.appendChild(card);
            });
        }

        // Analyze images when the "Analyze Images" button is pressed
        function predict() {
            if (filesToUpload.length === 0) {
                alert("Please upload images first.");
                return;
            }

            const formData = new FormData();
            filesToUpload.forEach(file => {
                formData.append('image', file);
            });

            document.getElementById('loading-indicator').style.display = 'block';

            // Make the request to the server to process the images
            fetch('/predict', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading-indicator').style.display = 'none';
                displayResults(data);
            })
            .catch(error => {
                console.error('Error:', error);
                alert("An error occurred while processing the images.");
                document.getElementById('loading-indicator').style.display = 'none';
            });
        }

// Display the results of predictions
function displayResults(data) {
    predictionResults.innerHTML = ''; // Clear previous results

    data.forEach((result, index) => {
        // Get the corresponding image card (we already have the preview)
        const card = imagePreviewContainer.children[index]; 

        const predictionResult = document.createElement('div');
        predictionResult.classList.add('prediction-result');

        // Create the prediction text
        const predictionText = document.createElement('p');
        predictionText.textContent = `Prediction: The car is ${result.prediction}`;
        predictionResult.appendChild(predictionText);

        // Display the original image if it hasn't been displayed yet
        if (!card.querySelector('img')) {
            const originalImage = document.createElement('img');
            originalImage.src = result.image_url;
            originalImage.alt = 'Original Image';
            originalImage.style.maxWidth = '100%';
            originalImage.style.height = 'auto';
            card.appendChild(originalImage);
        }

        // If there is a processed (segmented) image, display it
        if (result.processed_image_url) {
            const processedImage = document.createElement('img');
            processedImage.src = result.processed_image_url;
            processedImage.alt = 'Processed Image (Damage Segmentation)';
            processedImage.style.maxWidth = '100%';
            processedImage.style.height = 'auto';
            predictionResult.appendChild(processedImage);
        }

        // Display any additional message
        const damageMessage = document.createElement('p');
        damageMessage.textContent = result.message || '';  // Display damage message if available
        predictionResult.appendChild(damageMessage);

        // Append the prediction results under the image (or update the existing block)
        card.appendChild(predictionResult); 
    });
}


        // Reset page
        function resetPage() {
            inputImages.value = ''; 
            filesToUpload = [];
            imagePreviewContainer.innerHTML = ''; 
            predictionResults.innerHTML = ''; 
            document.getElementById('loading-indicator').style.display = 'none';
        }
    </script>
</body>
</html>
